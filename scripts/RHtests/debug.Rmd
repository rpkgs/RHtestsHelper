```{r}
varname = "RHavg"

res  <- RHtests_main(df, st_moveInfo, sites, varname)
```


# 诊断异常的站点

- `metadata`: 记录的是站点迁移信息

```{r}
sitename = sites[15]

d <- df[site == sitename, .SD, .SDcols = c("date", varname)]
print(head(d))

date_begin <- d$date[1]
date_end <- d$date[nrow(d)]

# 站点的微略移动，可以忽略不计
metadata <- st_moveInfo[site == sitename, ] %>%
  .[period_date_begin > date_begin & period_date_end < date_end, ] %>% 
  mutate(date = period_date_begin)
metadata
```

```{r}
l <- RHtests_input(d)
## 以monthly为准
prefix <- "./OUTPUT/example01"

r_month <- RHtests_process2(l$month, NULL, metadata, is_plot = TRUE, maxgap = 366)
r_year <- RHtests_process2(l$year, NULL, metadata, is_plot = FALSE, maxgap = 366)
# TP <- r_month$TP
# r_daily <- RHtests_stepsize(l$day, NULL, TP, prefix = prefix, is_plot = TRUE)
# list(year = r_year, month = r_month)
```


